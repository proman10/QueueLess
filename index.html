<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Join Queue</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #020617;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.box {
  background: #1e293b;
  padding: 20px;
  border-radius: 12px;
  width: 330px;
  text-align: center;
}

input, select {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  border: none;
  border-radius: 8px;
  background: #3b82f6;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

#token {
  margin-top: 15px;
  font-size: 18px;
  font-weight: bold;
  color: #93c5fd;
}

#status {
  margin-top: 8px;
}
</style>
</head>

<body>

<div class="box">
  <h2 id="title">Join Queue</h2>

  <select id="lang">
    <option value="en">English</option>
    <option value="hi">हिंदी</option>
    <option value="te">తెలుగు</option>
  </select>

  <input id="name" placeholder="Full Name">
  <input id="age" type="number" placeholder="Age">
  <button id="joinBtn">Join Queue</button>

  <p id="token"></p>
  <p id="status"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB8qFdxKNjEE1LjaDYcRcGa6OlB_vc_ePo",
  authDomain: "queueless-5a7e6.firebaseapp.com",
  databaseURL: "https://queueless-5a7e6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "queueless-5a7e6",
  storageBucket: "queueless-5a7e6.firebasestorage.app",
  messagingSenderId: "403169758788",
  appId: "1:403169758788:web:f6e02f17480a629df7f611"
};

firebase.initializeApp(firebaseConfig);
const queueRef = firebase.database().ref("queue");

const nameInput = document.getElementById("name");
const ageInput = document.getElementById("age");
const joinBtn = document.getElementById("joinBtn");
const tokenEl = document.getElementById("token");
const statusEl = document.getElementById("status");
const langSel = document.getElementById("lang");

let myKey = localStorage.getItem("queueKey");

const TEXT = {
  en: {
    enter: "Please enter name and age.",
    name: "Enter a real name (letters only).",
    age: "Age must be between 1 and 100.",
    wait: "Please wait. Your turn will come.",
    almost: "You are almost there.",
    next: "You’re next. Please be ready.",
    now: "You are being served now.",
    done: "You have been served."
  },
  hi: {
    enter: "नाम और उम्र दर्ज करें।",
    name: "कृपया सही नाम दर्ज करें।",
    age: "उम्र 1 से 100 के बीच होनी चाहिए।",
    wait: "कृपया प्रतीक्षा करें।",
    almost: "आपकी बारी आने वाली है।",
    next: "आप अगले हैं।",
    now: "आपकी सेवा हो रही है।",
    done: "आपकी सेवा हो चुकी है।"
  },
  te: {
    enter: "పేరు మరియు వయసు నమోదు చేయండి.",
    name: "దయచేసి సరైన పేరు నమోదు చేయండి.",
    age: "వయసు 1 నుండి 100 మధ్య ఉండాలి.",
    wait: "దయచేసి వేచి ఉండండి.",
    almost: "మీ వంతు దగ్గరలో ఉంది.",
    next: "మీరు తదుపరి.",
    now: "మీ సేవ జరుగుతోంది.",
    done: "మీ సేవ పూర్తైంది."
  }
};

joinBtn.addEventListener("click", joinQueue);

function joinQueue() {
  const rawName = nameInput.value.trim();
  const ageVal = parseInt(ageInput.value.trim());
  const lang = langSel.value;

  if (!rawName || !ageVal) {
    statusEl.innerText = TEXT[lang].enter;
    return;
  }

  if (ageVal < 1 || ageVal > 100) {
    statusEl.innerText = TEXT[lang].age;
    return;
  }

  const nameRegex = /^[A-Za-z\s]+$/;
  if (!nameRegex.test(rawName)) {
    statusEl.innerText = TEXT[lang].name;
    return;
  }

  const lettersOnly = rawName.replace(/\s/g, "");
  if (lettersOnly.length < 3 || /^(.)\1+$/.test(lettersOnly)) {
    statusEl.innerText = TEXT[lang].name;
    return;
  }

  const cleanName = rawName.toLowerCase();

  queueRef.once("value", snap => {
    const data = snap.val();
    if (data) {
      for (let k in data) {
        if (data[k].name === cleanName && data[k].age == ageVal) {
          myKey = k;
          localStorage.setItem("queueKey", myKey);
          return;
        }
      }
    }

    const ref = queueRef.push({
      name: cleanName,
      displayName: rawName,
      age: ageVal,
      joinedAt: Date.now()
    });

    myKey = ref.key;
    localStorage.setItem("queueKey", myKey);
  });
}

queueRef.on("value", snap => {
  if (!myKey) return;
  const lang = langSel.value;
  const data = snap.val();

  if (!data || !data[myKey]) {
    tokenEl.innerText = "";
    statusEl.innerText = TEXT[lang].done;
    localStorage.removeItem("queueKey");
    return;
  }

  const sorted = Object.entries(data).sort((a,b)=>a[1].joinedAt-b[1].joinedAt);
  const tokenNo = sorted.findIndex(e=>e[0]===myKey)+1;

  tokenEl.innerText = "Token: " + tokenNo;

  statusEl.innerText =
    tokenNo > 5 ? TEXT[lang].wait :
    tokenNo > 2 ? TEXT[lang].almost :
    tokenNo === 2 ? TEXT[lang].next :
    TEXT[lang].now;
});
</script>

</body>
</html>
