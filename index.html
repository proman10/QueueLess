<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QueueLess</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Inter,sans-serif;
  background:#020617;
  color:#e5e7eb;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.box{
  width:360px;
  background:#0b1220;
  padding:24px;
  border-radius:18px;
  box-shadow:0 25px 60px rgba(0,0,0,.45);
  text-align:center;
}

input,select{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:12px;
  border:1px solid #1e293b;
  background:#020617;
  color:white;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:600;
  margin-top:10px;
  cursor:pointer;
}

.join{
  background:linear-gradient(135deg,#3b82f6,#2563eb);
  color:white;
}

.leave{
  background:#1e293b;
  color:#fca5a5;
  display:none;
}

small{
  color:#94a3b8;
}
</style>
</head>

<body>

<div class="box">
  <h2>Join Queue</h2>

  <select id="lang">
    <option value="en">English</option>
    <option value="hi">हिंदी</option>
    <option value="te">తెలుగు</option>
  </select>

  <input id="name" placeholder="Full Name">
  <input id="age" type="number" placeholder="Age">

  <button class="join" id="joinBtn">Join Queue</button>
  <button class="leave" id="leaveBtn">Leave Queue</button>

  <p id="token"></p>
  <p id="status"></p>
  <small id="doctor"></small>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB8qFdxKNjEE1LjaDYcRcGa6OlB_vc_ePo",
  authDomain: "queueless-5a7e6.firebaseapp.com",
  databaseURL: "https://queueless-5a7e6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "queueless-5a7e6",
  storageBucket: "queueless-5a7e6.firebasestorage.app",
  messagingSenderId: "403169758788",
  appId: "1:403169758788:web:f6e02f17480a629df7f611"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const queueRef = db.ref("queue");
const metaRef = db.ref("meta");

const joinBtn = document.getElementById("joinBtn");
const leaveBtn = document.getElementById("leaveBtn");
const tokenEl = document.getElementById("token");
const statusEl = document.getElementById("status");
const doctorEl = document.getElementById("doctor");

let myKey = localStorage.getItem("queueKey");

// JOIN QUEUE
joinBtn.onclick = () => {
  const name = document.getElementById("name").value.trim();
  const age = document.getElementById("age").value.trim();
  if (!name || !age) {
    statusEl.innerText = "Please enter name and age.";
    return;
  }

  queueRef.push({
    displayName: name,
    age: age,
    joinedAt: Date.now()
  }).then(ref => {
    myKey = ref.key;
    localStorage.setItem("queueKey", myKey);
  });
};

// LEAVE QUEUE (FIXED)
leaveBtn.onclick = () => {
  if (!myKey) return;

  queueRef.child(myKey).once("value", snap => {
    if (!snap.exists()) return;

    queueRef.child(myKey).remove().then(() => {
      localStorage.removeItem("queueKey");
      myKey = null;

      tokenEl.innerText = "";
      statusEl.innerText = "You have left the queue.";
      leaveBtn.style.display = "none";
    });
  });
};

// QUEUE LISTENER
queueRef.on("value", snap => {
  if (!myKey) return;

  const data = snap.val();
  if (!data || !data[myKey]) {
    tokenEl.innerText = "";
    statusEl.innerText = "You have been served.";
    leaveBtn.style.display = "none";
    localStorage.removeItem("queueKey");
    myKey = null;
    return;
  }

  const sorted = Object.entries(data)
    .sort((a,b) => a[1].joinedAt - b[1].joinedAt);

  const index = sorted.findIndex(e => e[0] === myKey);
  const token = index + 1;

  tokenEl.innerText = "Token: " + token;
  leaveBtn.style.display = "block";

  statusEl.innerText =
    token > 5 ? "Please wait." :
    token > 2 ? "You are almost there." :
    token === 2 ? "You’re next." :
    "You are being served now.";
});

// DOCTOR NAME LISTENER
metaRef.child("doctorName").on("value", snap => {
  doctorEl.innerText = snap.exists() ? "Doctor: " + snap.val() : "";
});
</script>

</body>
</html>
