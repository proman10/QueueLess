<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QueueLess</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:#020617;
  color:#e5e7eb;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:360px;
  background:#0b1220;
  padding:24px;
  border-radius:18px;
  box-shadow:0 20px 50px rgba(0,0,0,.5);
  text-align:center;
}
h2{margin:0 0 12px;color:#e0f2fe}
select,input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:12px;
  border:1px solid #1e293b;
  background:#020617;
  color:white;
}
button{border:none;font-weight:600;cursor:pointer}
.join{background:#2563eb}
.leave{background:#1e293b;color:#fca5a5}
#token{font-size:20px;font-weight:700;color:#93c5fd;margin-top:12px}
#status{margin-top:6px}
small{color:#94a3b8}
</style>
</head>

<body>
<div class="card">
  <h2 id="title">Join Queue</h2>

  <select id="lang">
    <option value="en">English</option>
    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
    <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
  </select>

  <input id="name" placeholder="Full Name">
  <input id="age" type="number" placeholder="Age">

  <button class="join" id="joinBtn">Join Queue</button>
  <button class="leave" id="leaveBtn" style="display:none">Leave Queue</button>

  <div id="token"></div>
  <div id="status"></div>
  <small id="doctor"></small>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyB8qFdxKNjEE1LjaDYcRcGa6OlB_vc_ePo",
  authDomain:"queueless-5a7e6.firebaseapp.com",
  databaseURL:"https://queueless-5a7e6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"queueless-5a7e6"
});

const db = firebase.database();
const queueRef = db.ref("queue");
const doctorRef = db.ref("currentDoctor");

let myKey = localStorage.getItem("queueKey");

const TEXT={
  en:{title:"Join Queue",invalid:"Enter valid name (letters only)",age:"Age must be 1‚Äì100",dup:"You are already in the queue"},
  hi:{title:"‡§ï‡§§‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç",invalid:"‡§∏‡§π‡•Ä ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",age:"‡§â‡§Æ‡•ç‡§∞ 1‚Äì100"},
  te:{title:"‡∞ï‡±ç‡∞Ø‡±Ç‡∞≤‡±ã ‡∞ö‡±á‡∞∞‡∞Ç‡∞°‡∞ø",invalid:"‡∞∏‡∞∞‡±à‡∞® ‡∞™‡±á‡∞∞‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",age:"‡∞µ‡∞Ø‡∞∏‡±Å 1‚Äì100"}
};

const lang=document.getElementById("lang");
lang.onchange=()=>title.innerText=TEXT[lang.value].title;
lang.onchange();

joinBtn.onclick=()=>{
  const raw=name.value.trim();
  const ageVal=parseInt(age.value);

  if(!/^[A-Za-z ]{3,}$/.test(raw)){
    status.innerText=TEXT[lang.value].invalid;return;
  }
  if(ageVal<1||ageVal>100){
    status.innerText=TEXT[lang.value].age;return;
  }

  const clean=raw.toLowerCase();

  queueRef.once("value",snap=>{
    const data=snap.val()||{};
    for(let k in data){
      if(data[k].name===clean && data[k].age==ageVal){
        myKey=k;
        localStorage.setItem("queueKey",myKey);
        leaveBtn.style.display="block";
        updateUI(data);
        status.innerText=TEXT[lang.value].dup;
        return;
      }
    }

    queueRef.push({
      name:clean,
      displayName:raw,
      age:ageVal,
      joinedAt:Date.now()
    }).then(ref=>{
      myKey=ref.key;
      localStorage.setItem("queueKey",myKey);
      leaveBtn.style.display="block";

      // üî• TOKEN BUG FIX: force immediate UI refresh
      queueRef.once("value",snap=>updateUI(snap.val()));
    });
  });
};

leaveBtn.onclick=()=>{
  if(myKey){
    queueRef.child(myKey).remove();
    localStorage.removeItem("queueKey");
    location.reload();
  }
};

function updateUI(data){
  if(!myKey||!data||!data[myKey])return;

  const sorted=Object.entries(data).sort((a,b)=>a[1].joinedAt-b[1].joinedAt);
  const pos=sorted.findIndex(e=>e[0]===myKey)+1;

  token.innerText="Token "+pos;
  status.innerText=
    pos>5?"Please wait":
    pos>2?"You are almost there":
    pos===2?"You‚Äôre next":
    "You are being served now";
}

queueRef.on("value",snap=>updateUI(snap.val()));

doctorRef.on("value",snap=>{
  doctor.innerText=snap.val()?("Doctor: "+snap.val()):"";
});
</script>
</body>
</html>
