<!DOCTYPE html>
<html>
<head>
  <title>QueueLess</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #020617;
      color: white;
      text-align: center;
      padding-top: 40px;
    }
    .box {
      background: #1e293b;
      padding: 20px;
      width: 320px;
      margin: auto;
      border-radius: 12px;
    }
    input, button {
      padding: 10px;
      width: 90%;
      margin: 6px;
      border-radius: 6px;
      border: none;
    }
    button {
      background: #3b82f6;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>Join Queue</h2>

  <input id="name" placeholder="Full Name">
  <input id="age" type="number" placeholder="Age">
  <button onclick="joinQueue()">Join Queue</button>

  <p id="status"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  databaseURL: "https://queueless-5a7e6-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);

const queueRef = firebase.database().ref("queue");

let myKey = null;

/* JOIN QUEUE WITH DUPLICATE CHECK */
function joinQueue() {
  const rawName = document.getElementById("name").value.trim();
  const age = document.getElementById("age").value.trim();
  if (!rawName || !age) return;

  const name = rawName.toLowerCase();

  queueRef.once("value", snap => {
    const data = snap.val();

    if (data) {
      for (let key in data) {
        if (
          data[key].name === name &&
          data[key].age === age
        ) {
          myKey = key;
          document.getElementById("status").innerText =
            "You are already in the queue.";
          return;
        }
      }
    }

    const ref = queueRef.push({
      name: name,
      displayName: rawName,
      age: age,
      joinedAt: Date.now()
    });

    myKey = ref.key;
    document.getElementById("status").innerText =
      "Joined successfully. Please wait.";
  });
}

/* WAIT MESSAGE LOGIC */
queueRef.on("value", snap => {
  if (!myKey) return;

  const data = snap.val();
  if (!data || !data[myKey]) return;

  const keys = Object.keys(data);
  const index = keys.indexOf(myKey);

  let msg = "";

  if (index > 5) {
    msg = "Please wait. Your turn will come.";
  } else if (index === 5) {
    msg = "Please wait. Your turn will come.";
  } else if (index < 5 && index > 1) {
    msg = "ðŸŸ¡ You are almost there. Please be ready.";
  } else if (index === 1) {
    msg = "ðŸŸ¢ Youâ€™re next. Please stay nearby.";
  } else if (index === 0) {
    msg = "ðŸ”µ You are being served now.";
  }

  document.getElementById("status").innerText = msg;
});
</script>

</body>
</html>
