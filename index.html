<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Join Queue</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .box {
      background: #1e293b;
      padding: 25px;
      border-radius: 12px;
      width: 320px;
      text-align: center;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
    }
    button {
      background: #3b82f6;
      color: white;
      cursor: pointer;
    }
    button.leave {
      background: #ef4444;
    }
    p {
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="box">
  <h2>Join Queue</h2>

  <input id="name" placeholder="Full Name">
  <input id="age" type="number" placeholder="Age (max 100)">
  <button id="joinBtn">Join Queue</button>

  <p id="token"></p>
  <p id="status"></p>
  <p id="doctor"></p>

  <button class="leave" id="leaveBtn" style="display:none;">Leave Queue</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB8qFdxKNjEE1LjaDYcRcGa6OlB_vc_ePo",
  authDomain: "queueless-5a7e6.firebaseapp.com",
  databaseURL: "https://queueless-5a7e6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "queueless-5a7e6",
  storageBucket: "queueless-5a7e6.firebasestorage.app",
  messagingSenderId: "403169758788",
  appId: "1:403169758788:web:f6e02f17480a629df7f611"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const queueRef = db.ref("queue");
const doctorRef = db.ref("currentDoctor");

const nameInput = document.getElementById("name");
const ageInput = document.getElementById("age");
const joinBtn = document.getElementById("joinBtn");
const leaveBtn = document.getElementById("leaveBtn");
const tokenEl = document.getElementById("token");
const statusEl = document.getElementById("status");
const doctorEl = document.getElementById("doctor");

let myKey = null;

// Join Queue
joinBtn.onclick = () => {
  const name = nameInput.value.trim();
  const age = ageInput.value.trim();

  if (!name || !age || age > 100) {
    statusEl.innerText = "Enter valid name and age.";
    return;
  }

  queueRef.push({
    displayName: name,
    age: age,
    joinedAt: Date.now()
  }).then(ref => {
    myKey = ref.key;
    leaveBtn.style.display = "block";
  });
};

// Leave Queue
leaveBtn.onclick = () => {
  if (!myKey) return;

  queueRef.child(myKey).remove().then(() => {
    myKey = null;
    tokenEl.innerText = "";
    statusEl.innerText = "You have left the queue.";
    leaveBtn.style.display = "none";
  });
};

// Live Queue Updates
queueRef.on("value", snap => {
  if (!myKey) return;

  const data = snap.val();
  if (!data || !data[myKey]) {
    myKey = null;
    tokenEl.innerText = "";
    statusEl.innerText = "You have been served.";
    leaveBtn.style.display = "none";
    return;
  }

  const sorted = Object.entries(data)
    .sort((a,b) => a[1].joinedAt - b[1].joinedAt);

  const index = sorted.findIndex(e => e[0] === myKey);
  const tokenNo = index + 1;

  tokenEl.innerText = "Token Number: " + tokenNo;

  if (tokenNo > 5) statusEl.innerText = "Please wait.";
  else if (tokenNo > 2) statusEl.innerText = "You are almost there.";
  else if (tokenNo === 2) statusEl.innerText = "You are next.";
  else statusEl.innerText = "You are being served now.";
});

// Doctor Name
doctorRef.on("value", snap => {
  if (snap.exists()) {
    doctorEl.innerText = "Doctor: " + snap.val();
  }
});
</script>

</body>
</html>
